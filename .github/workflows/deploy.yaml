name: Deploy to DigitalOcean Kubernetes

on:
    push:
        branches: ['main']

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Login to Docker Hub
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            # Build the API image using docker compose
            - name: Build API image
              run: docker compose build api

            # Tag the image for Docker Hub
            - name: Tag API image for Docker Hub
              run: |
                LOCAL_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "trader:latest")
                docker tag $LOCAL_IMAGE ${{ secrets.DOCKERHUB_USERNAME }}/trader:prod

            # Push image to Docker Hub
            - name: Push image to Docker Hub
              run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/trader:prod

            # Install doctl
            - name: Install doctl
              uses: digitalocean/action-doctl@v2
              with:
                  token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            # Fetch kubeconfig
            - name: Fetch kubeconfig
              run: doctl kubernetes cluster kubeconfig save ${{ secrets.DO_CLUSTER_ID }}

            # Apply Prisma migration job
            - name: Apply Prisma migration
              run: |
                  kubectl apply -f k8s/prisma-migrate.yaml
                  kubectl wait --for=condition=complete job/prisma-migrate --timeout=90s

            # Apply app manifests
            - name: Deploy updated app
              run: |
                  kubectl apply -f k8s/postgres.yaml
                  kubectl apply -f k8s/deployment.yaml
                  kubectl apply -f k8s/service.yaml
            
            # Force rollout so Kubernetes pulls the newly pushed image
            - name: Restart Deployment
              run: kubectl rollout restart deployment trader
